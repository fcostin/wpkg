<?xml version="1.0" encoding="UTF-8"?>

<!--
NOTES
 1) We always remove the Apple Update package no matter what as it might be left over from previous installations
 2) We are now also removing the scheduled task that runs the updater
 3) The Bonjour package is no longer installed by default, but can easily be installed by adding the "bonjour" package to a profile
-->

<packages>

<package
  id="itunes"
  name="Apple iTunes"
  revision="%version%-0"
  reboot="false"
  priority="10">

  <depends package-id="applesupport" />
  <depends package-id="applemobile" />
  <depends package-id="quicktime" />

  <variable name="version" value="10.2.1.1" />

  <check type="uninstall" condition="versiongreaterorequal" path="iTunes" value="%version%"/>

  <install cmd='msiexec %MSI% /i "%SOFTWARE%\Apple\iTunes\%version%\%PROCESSOR_ARCHITECTURE%\iTunes.msi"' />
  <install cmd='msiexec %MSI% /x "%SOFTWARE%\Apple\AppleSoftwareUpdate.msi"'>
    <exit code="1605" />
    <exit code="0" />
  </install>
  <install cmd='REG DELETE "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v iTunesHelper /f'>
    <exit code="1" />
  </install>
  <install cmd='schtasks /delete AppleSoftwareUpdate /f'>
    <exit code="1" />
  </install>
  <install cmd='%COMSPEC% /c del /Q "%ALLUSERSPROFILE%\Desktop\iTunes.lnk"'>
    <exit code="any" />
  </install>
  <install cmd='%COMSPEC% /c del /Q "%PUBLIC%\Desktop\iTunes.lnk"'>
    <exit code="any" />
  </install>

  <upgrade cmd='msiexec %MSI% /i "%SOFTWARE%\Apple\iTunes\%version%\%PROCESSOR_ARCHITECTURE%\iTunes.msi"'>
    <exit code="any" />
  </upgrade>
  <upgrade cmd='msiexec %MSI% /x "%SOFTWARE%\Apple\AppleSoftwareUpdate.msi"'>
    <exit code="1605" />
    <exit code="0" />
  </upgrade>
  <upgrade cmd='REG DELETE "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v iTunesHelper /f'>
    <exit code="1" />
  </upgrade>
  <upgrade cmd='schtasks /delete AppleSoftwareUpdate /f'>
    <exit code="1" />
  </upgrade>
  <upgrade cmd='%COMSPEC% /c del /Q "%ALLUSERSPROFILE%\Desktop\iTunes.lnk"'>
    <exit code="any" />
  </upgrade>
  <upgrade cmd='%COMSPEC% /c del /Q "%PUBLIC%\Desktop\iTunes.lnk"'>
    <exit code="any" />
  </upgrade>

  <downgrade cmd='msiexec %MSI% /fa "%SOFTWARE%\Apple\iTunes\%version%\%PROCESSOR_ARCHITECTURE%\iTunes.msi"'>
    <exit code="any" />
  </downgrade>
  <downgrade cmd='msiexec %MSI% /x "%SOFTWARE%\Apple\AppleSoftwareUpdate.msi"'>
    <exit code="1605" />
    <exit code="0" />
  </downgrade>
  <downgrade cmd='REG DELETE "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v iTunesHelper /f'>
    <exit code="1" />
  </downgrade>
  <downgrade cmd='schtasks /delete AppleSoftwareUpdate /f'>
    <exit code="1" />
  </downgrade>
  <downgrade cmd='%COMSPEC% /c del /Q "%ALLUSERSPROFILE%\Desktop\iTunes.lnk"'>
    <exit code="any" />
  </downgrade>
  <downgrade cmd='%COMSPEC% /c del /Q "%PUBLIC%\Desktop\iTunes.lnk"'>
    <exit code="any" />
  </downgrade>

  <remove cmd='msiexec %MSI% /x "%SOFTWARE%\Apple\iTunes\%version%\%PROCESSOR_ARCHITECTURE%\iTunes.msi"'>
    <exit code="3010" />
  </remove>
  <remove cmd='msiexec %MSI% /x "%SOFTWARE%\Apple\AppleSoftwareUpdate.msi"'>
    <exit code="1605" />
    <exit code="0" />
  </remove>
</package>

<package
  id="applemobile"
  name="Apple Mobile Device Support"
  revision="%version%-0"
  reboot="false"
  priority="10">

  <variable name="version" value="3.4.0.25" />

  <check type="uninstall"  condition="versiongreaterorequal" path="Apple Mobile Device Support" value="%version%"/>
  <install   cmd='msiexec %MSI% /i "%SOFTWARE%\Apple\MobileDevice\%version%\%PROCESSOR_ARCHITECTURE%\AppleMobileDeviceSupport.msi"' />
  <upgrade   cmd='msiexec %MSI% /i "%SOFTWARE%\Apple\MobileDevice\%version%\%PROCESSOR_ARCHITECTURE%\AppleMobileDeviceSupport.msi"' />
  <downgrade cmd='msiexec %MSI% /fa "%SOFTWARE%\Apple\MobileDevice\%version%\%PROCESSOR_ARCHITECTURE%\AppleMobileDeviceSupport.msi"' />
  <remove    cmd='msiexec %MSI% /x "%SOFTWARE%\Apple\MobileDevice\%version%\%PROCESSOR_ARCHITECTURE%\AppleMobileDeviceSupport.msi"' />
</package>

<package
  id="applesupport"
  name="Apple Software Application Support"
  revision="%version%-0"
  reboot="false"
  priority="10">

  <variable name="version" value="1.5.0" />

  <check type="uninstall"  condition="versiongreaterorequal" path="Apple Application Support" value="%version%"/>
  <install   cmd='msiexec %MSI% /i "%SOFTWARE%\Apple\AppleApplicationSupport.msi"' />
  <upgrade   cmd='msiexec %MSI% /i "%SOFTWARE%\Apple\AppleApplicationSupport.msi"' />
  <downgrade cmd='msiexec %MSI% /fa "%SOFTWARE%\Apple\AppleApplicationSupport.msi"' />
  <remove    cmd='msiexec %MSI% /x "%SOFTWARE%\Apple\AppleApplicationSupport.msi"' />
</package>

<package
  id="bonjour"
  name="Bonjour"
  revision="%version%-2"
  reboot="false"
  priority="10">

  <variable name="version" value="2.0.4.0" />

  <check type="uninstall" condition="versiongreaterorequal" path="Bonjour" value="%version%"/>
  <install   cmd='msiexec %MSI% /i "%SOFTWARE%\Apple\Bonjour\%version%\%PROCESSOR_ARCHITECTURE%\bonjour.msi"' />
  <upgrade   cmd='msiexec %MSI% /i "%SOFTWARE%\Apple\Bonjour\%version%\%PROCESSOR_ARCHITECTURE%\bonjour.msi"' />
  <downgrade cmd='msiexec %MSI% /fa "%SOFTWARE%\Apple\Bonjour\%version%\%PROCESSOR_ARCHITECTURE%\bonjour.msi"' />
  <remove    cmd='msiexec %MSI% /x "%SOFTWARE%\Apple\Bonjour\%version%\%PROCESSOR_ARCHITECTURE%\bonjour.msi"' />
</package>

<!-- TODO: check if the QuickTime Task job is also deleted on 64 bit windows -->

<package
  id="quicktime"
  name="Apple Quicktime"
  revision="%version%-3"
  reboot="false"
  priority="10">

  <variable name="version" value="7.69.80.9" />
  <variable name="RUN" value="HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" />

  <check type="uninstall" condition="versiongreaterorequal" path="QuickTime" value="%version%"/>

  <install cmd='msiexec %MSI% /i "%SOFTWARE%\Apple\QuickTime\%version%\QuickTime.msi"' />
  <install cmd='REG DELETE %RUN% /v "QuickTime Task" /f'>
    <exit code="1" />
  </install>
  <install cmd='%COMSPEC% /c del /F /Q "%ALLUSERSPROFILE%\Desktop\QuickTime Player.lnk"'>
    <exit code="1" />
  </install>
  <install cmd='%COMSPEC% /c del /F /Q "%PUBLIC%\Desktop\QuickTime Player.lnk"'>
    <exit code="1" />
  </install>

  <upgrade cmd='msiexec %MSI% /i "%SOFTWARE%\Apple\QuickTime\%version%\QuickTime.msi"' />
  <upgrade cmd='REG DELETE %RUN% /v "QuickTime Task" /f'>
    <exit code="1" />
  </upgrade>
  <upgrade cmd='%COMSPEC% /c del /F /Q "%ALLUSERSPROFILE%\Desktop\QuickTime Player.lnk"'>
    <exit code="1" />
  </upgrade>
  <upgrade cmd='%COMSPEC% /c del /F /Q "%PUBLIC%\Desktop\QuickTime Player.lnk"'>
    <exit code="1" />
  </upgrade>

  <downgrade cmd='msiexec %MSI% /fa "%SOFTWARE%\Apple\QuickTime\%version%\QuickTime.msi"' />
  <downgrade cmd='REG DELETE %RUN% /v "QuickTime Task" /f'>
    <exit code="1" />
  </downgrade>
  <downgrade cmd='%COMSPEC% /c del /F /Q "%ALLUSERSPROFILE%\Desktop\QuickTime Player.lnk"'>
    <exit code="1" />
  </downgrade>
  <downgrade cmd='%COMSPEC% /c del /F /Q "%PUBLIC%\Desktop\QuickTime Player.lnk"'>
    <exit code="1" />
  </downgrade>

  <remove  cmd='msiexec %MSI% /x "%SOFTWARE%\Apple\QuickTime\%version%\QuickTime.msi"' />
</package>

<package
  id="iphone_config"
  name="Apple iPhone Configuration Utility"
  revision="%version%-3"
  reboot="false"
  priority="10">

  <depends package-id="applesupport" />
  <depends package-id="applemobile" />

  <variable name="version" value="3.2.0.267" />

  <check type="uninstall" condition="versiongreaterorequal" path="iPhone Configuration Utility" value="%version%"/>

  <install cmd='msiexec %MSI% /i "%SOFTWARE%\Apple\iPhoneConfig\%version%\iPhoneConfigUtility.msi"' />
  <install cmd='msiexec %MSI% /x "%SOFTWARE%\Apple\AppleSoftwareUpdate.msi"'>
    <exit code="1605" />
    <exit code="0" />
  </install>
  <install cmd='schtasks /delete AppleSoftwareUpdate /f'>
    <exit code="1" />
  </install>

  <upgrade cmd='msiexec %MSI% /i "%SOFTWARE%\Apple\iPhoneConfig\%version%\iPhoneConfigUtility.msi"' />
  <upgrade cmd='msiexec %MSI% /x "%SOFTWARE%\Apple\AppleSoftwareUpdate.msi"'>
    <exit code="1605" />
    <exit code="0" />
  </upgrade>
  <upgrade cmd='schtasks /delete AppleSoftwareUpdate /f'>
    <exit code="1" />
  </upgrade>

  <remove  cmd='msiexec %MSI% /x "%SOFTWARE%\Apple\iPhoneConfig\%version%\iPhoneConfigUtility.msi"' />
  <remove  cmd='msiexec %MSI% /x "%SOFTWARE%\Apple\AppleSoftwareUpdate.msi"'>
    <exit code="1605" />
    <exit code="0" />
  </remove>
  <remove  cmd='schtasks /delete AppleSoftwareUpdate /f'>
    <exit code="1" />
  </remove>
</package>

</packages>
