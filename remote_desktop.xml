<?xml version="1.0" encoding="UTF-8"?>

<packages>

<package
  id="rdp"
  name="Enable RDP"
  revision="6"
  reboot="false"
  priority="50">

  <variable name="keypath" value="HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" />
  <variable name="key" value="fDenyTSConnections" />

  <check type="logical" condition="and">
    <check type="registry" condition="equals" path="%keypath%\%key%" value="0" />
    <check type="registry" condition="exists" path="HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\KB969084" />
  </check>

  <install cmd='REG ADD "%keypath%" /v "%key%" /t REG_DWORD /d 0 /f' />
  <install cmd='netsh firewall set service remoteadmin enable' />
  <install cmd='netsh firewall set service remotedesktop enable' />
  <install cmd='%COMSPEC% /C FOR /F "usebackq tokens=*" %A IN (`"%WPKG%\tools\localetool.exe" abbrlang`) DO "%SOFTWARE%\RDP\WindowsXP-KB969084-x86-%A.exe" %MSI%' />

  <upgrade cmd='REG ADD "%keypath%" /v "%key%" /t REG_DWORD /d 0 /f' />
  <upgrade cmd='netsh firewall set service remoteadmin enable' />
  <upgrade cmd='netsh firewall set service remotedesktop enable' />
  <upgrade cmd='%COMSPEC% /C FOR /F "usebackq tokens=*" %A IN (`"%WPKG%\tools\localetool.exe" abbrlang`) DO "%SOFTWARE%\RDP\WindowsXP-KB969084-x86-%A.exe" %MSI%' />

  <remove  cmd='REG ADD "%keypath%" /v "%key%" /t REG_DWORD /d 1 /f' />
  <remove  cmd='netsh firewall set service remoteadmin disable' />
  <remove  cmd='netsh firewall set service remotedesktop disable' />
  <remove  cmd='"%WINDIR%\$NtUninstallKB969084$\spuninst\spuninst.exe" /quiet /norestart' />

</package>

</packages>
