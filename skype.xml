<?xml version="1.0" encoding="UTF-8"?>

<!--
  NOTES
  1) Skype uses a TM symbol in the name in the Uninstall string so to play it safe, we instead check the version of the file name directly
  2) Furthermore, the versions are different. Uninstall version would be 5.0.156 but fileversion is 5.0.32.156
  3) INSTALLLEVEL=1 means no toolbars
  4) Skype will choke on the install if we are trying to upgrade minor versions - like from .152 to .156 and throw a 1638 error. That's why we run the installer twice - first time it might throw 1638, so we then just run it again with REINSTALL set.
-->

<packages>

<package
  id="skype"
  name="Skype 5.0"
  revision="%version%-1"
  reboot="false"
  priority="10">

  <variable name='version' value='5.0.32.156' />
  <variable name='flags' value='INSTALLLEVEL=1 ALLUSERS=1 STARTSKYPE=FALSE' />
  
  <check type="logical" condition="or">
    <check type="file" condition="versiongreaterorequal" path="%PROGRAMFILES%\Skype\Phone\Skype.exe" value="%version%" />
    <check type="file" condition="versiongreaterorequal" path="%PROGRAMFILES(x86)%\Skype\Phone\Skype.exe" value="%version%" />
  </check>

  <install cmd='msiexec %MSI% /i "%SOFTWARE%\Skype\SkypeSetup.msi" %flags%'><exit code="1638" /></install>
  <install cmd='msiexec %MSI% /i "%SOFTWARE%\Skype\SkypeSetup.msi" %flags% REINSTALLMODE=omus REINSTALL=ALL'/>
  <install cmd='%COMSPEC% /C reg add "HKLM\Software\Policies\Skype\Phone" /v "DisableVersionCheckPolicy" /d "1" /t REG_DWORD /f' />
  <install cmd='%COMSPEC% /C reg add "HKLM\Software\Policies\Skype\Phone" /v "DisableSupernodePolicy" /d "1" /t REG_DWORD /f' />
  <install cmd='%COMSPEC% /C reg delete "HKU\.DEFAULT\Software\Microsoft\Windows\CurrentVersion\Run" /v "Skype" /f' />
  
  <upgrade cmd='msiexec %MSI% /i "%SOFTWARE%\Skype\SkypeSetup.msi" %flags%'><exit code="1638" /></upgrade>
  <upgrade cmd='msiexec %MSI% /i "%SOFTWARE%\Skype\SkypeSetup.msi" %flags% REINSTALLMODE=omus REINSTALL=ALL'/>
  <upgrade cmd='%COMSPEC% /C reg add "HKLM\Software\Policies\Skype\Phone" /v "DisableVersionCheckPolicy" /d "1" /t REG_DWORD /f' />
  <upgrade cmd='%COMSPEC% /C reg add "HKLM\Software\Policies\Skype\Phone" /v "DisableSupernodePolicy" /d "1" /t REG_DWORD /f' />
  <upgrade cmd='%COMSPEC% /C reg delete "HKU\.DEFAULT\Software\Microsoft\Windows\CurrentVersion\Run" /v "Skype" /f' />

  <downgrade cmd='msiexec %MSI% /i "%SOFTWARE%\Skype\SkypeSetup.msi" %flags%'><exit code="1638" /></downgrade>
  <downgrade cmd='msiexec %MSI% /i "%SOFTWARE%\Skype\SkypeSetup.msi" %flags% REINSTALLMODE=omus REINSTALL=ALL'/>
  <downgrade cmd='%COMSPEC% /C reg add "HKLM\Software\Policies\Skype\Phone" /v "DisableVersionCheckPolicy" /d "1" /t REG_DWORD /f' />
  <downgrade cmd='%COMSPEC% /C reg add "HKLM\Software\Policies\Skype\Phone" /v "DisableSupernodePolicy" /d "1" /t REG_DWORD /f' />
  <downgrade cmd='%COMSPEC% /C reg delete "HKU\.DEFAULT\Software\Microsoft\Windows\CurrentVersion\Run" /v "Skype" /f' />

  <remove    cmd='%COMSPEC% /C if exist "%PROGRAMFILES%\Skype\Phone\Skype.exe" "%PROGRAMFILES%\Skype\Phone\Skype.exe" /shutdown' />
  <remove    cmd='%COMSPEC% /C if exist "%PROGRAMFILES(x86)%\Skype\Phone\Skype.exe" "%PROGRAMFILES(x86)%\Skype\Phone\Skype.exe" /shutdown' />
  <remove    cmd='msiexec %MSI% /x "%SOFTWARE%\Skype\SkypeSetup.msi"' />

</package>

</packages>
